pipeline {
    
    // Ejecuta el pipeline en cualquier agente disponible.
    // IMPORTANTE: Este agente debe tener 'checkov' disponible en su PATH 
    // o debe ser una imagen de Docker configurada (como 'jenkins-checkov:latest').
    agent any

    stages {
        
        stage ('checkov disable skip') {
            steps {
                script {
                    sh "echo 'Iniciando escaneo de Checkov'"
                }
            }
        }

        stage ('Security Scan (Checkov)') {
            steps {
                script {
                    echo "Ejecutando Checkov para escanear el código..."
                    
                    // Comandos Corregidos:
                    // 1. Usar la ruta absoluta del binario si es necesario (ej: /usr/local/bin/checkov)
                    // 2. Agregar el formato de salida '-o junit --output-file' para generar el reporte
                    // 3. La ruta './dockerCheckov/' es la carpeta con tu código IAC
                    sh "/usr/local/bin/checkov -d ./dockerCheckov/ -o junit --output-file checkov_report.xml"
                }
            }
        }

        stage ('Deploy') {
            steps {
                script {
                    sh "echo 'Iniciando despliegue...'"
                }
            }
        }
    }
    
    // --- POST-BUILD ACTIONS: Publicar Reporte ---
    post {
        // La sección 'always' asegura que el reporte se publique, 
        // incluso si el stage de Checkov falla debido a vulnerabilidades.
        always {
            script {
                echo "Publicando reporte de Checkov en la interfaz de Jenkins..."
                // Busca el reporte XML generado por el stage de Checkov
                junit 'dockerCheckov/checkov_report.xml'
            }
        }
    }
}